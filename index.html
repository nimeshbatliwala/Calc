<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Jaguar V12 Platinum - Final Edition</title>
    <style>
        :root { --round: 60px; --depth: 6px; }
        /* 20 DYNAMIC THEMES */
        body.t-0 { --car: #ff1a1a; --accent: #ffffff; --shape: 60px 60px 100px 100px; --key: #151515; --glow: #ffffff; --text: #fff; } 
        body.t-1 { --car: #050505; --accent: #00f2ff; --shape: 20px 20px 80px 80px; --key: #111111; --glow: #00f2ff; --text: #fff; } 
        body.t-2 { --car: #f39c12; --accent: #ffdd00; --shape: 80px 20px 80px 20px; --key: #1c1c1c; --glow: #ffdd00; --text: #fff; } 
        body.t-3 { --car: #ffffff; --accent: #ff0000; --shape: 60px 60px 60px 60px; --key: #f2f2f2; --glow: #ff0000; --text: #111; } 
        body.t-4 { --car: #00ff88; --accent: #ffffff; --shape: 40px 120px 40px 120px; --key: #051a10; --glow: #00ff88; --text: #fff; } 
        body.t-5 { --car: #7000ff; --accent: #00ffcc; --shape: 100px 100px 100px 100px; --key: #150030; --glow: #00ffcc; --text: #fff; } 
        body.t-6 { --car: #ff007f; --accent: #ffffff; --shape: 150px 30px 150px 30px; --key: #200010; --glow: #ff007f; --text: #fff; } 
        body.t-7 { --car: #0066ff; --accent: #00e5ff; --shape: 40px 40px 120px 120px; --key: #001a33; --glow: #00e5ff; --text: #fff; }
        body.t-8 { --car: #2c003e; --accent: #00d2ff; --shape: 100px 20px 100px 20px; --key: #1a0025; --glow: #00d2ff; --text: #fff; }
        body.t-9 { --car: #003366; --accent: #ffffff; --shape: 50px 50px 10px 10px; --key: #001f3d; --glow: #ffffff; --text: #fff; }
        body.t-10 { --car: #e0ac9d; --accent: #ffffff; --shape: 70px 70px 70px 70px; --key: #4a332d; --glow: #fff; --text: #fff; }
        body.t-11 { --car: #222; --accent: #adff2f; --shape: 30px 30px 120px 120px; --key: #111; --glow: #adff2f; --text: #fff; }
        body.t-12 { --car: #800000; --accent: #ffd700; --shape: 90px 40px 90px 40px; --key: #300000; --glow: #ffd700; --text: #fff; }
        body.t-13 { --car: #004d40; --accent: #80cbc4; --shape: 20px 150px 20px 150px; --key: #00251a; --glow: #80cbc4; --text: #fff; }
        body.t-14 { --car: #1a237e; --accent: #ffeb3b; --shape: 100px 100px 0 0; --key: #000051; --glow: #ffeb3b; --text: #fff; }
        body.t-15 { --car: #4e342e; --accent: #d7ccc8; --shape: 40px 40px 40px 40px; --key: #260e04; --glow: #d7ccc8; --text: #fff; }
        body.t-16 { --car: #311b92; --accent: #ea80fc; --shape: 10px 80px 10px 80px; --key: #000063; --glow: #ea80fc; --text: #fff; }
        body.t-17 { --car: #bf360c; --accent: #ffccbc; --shape: 80px 80px 150px 150px; --key: #870000; --glow: #ffccbc; --text: #fff; }
        body.t-18 { --car: #1b5e20; --accent: #b9f6ca; --shape: 60px 0 60px 0; --key: #003308; --glow: #b9f6ca; --text: #fff; }
        body.t-19 { --car: #212121; --accent: #f44336; --shape: 120px 120px 120px 120px; --key: #000; --glow: #f44336; --text: #fff; }

        /* FIXED ROUND MODE - BIG KEYS */
        body.is-round #chassis { border-radius: 120px !important; }
        body.is-round .keypad { justify-items: center; align-items: center; gap: 8px; padding: 10px 15px 30px; }
        body.is-round .key { 
            border-radius: 50% !important; 
            aspect-ratio: 1 / 1; 
            width: 95%; 
            height: auto;
            box-shadow: 0 var(--depth) 0 rgba(0,0,0,0.5), inset 0 2px 2px rgba(255,255,255,0.1);
            transform: translateY(calc(-1 * var(--depth) / 2));
            font-size: 1.9rem;
        }
        body.is-round .key.active-glow { transform: translateY(calc(var(--depth) / 4)); box-shadow: 0 0 45px var(--glow) !important; }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; user-select: none; }
        html, body { width: 100vw; height: 100vh; overflow: hidden; background: #000; font-family: 'Inter', system-ui, sans-serif; position: fixed; }

        #splash { position: fixed; inset: 0; z-index: 5000; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.6s opacity; }
        .jag-logo { font-size: 90px; filter: drop-shadow(0 0 20px #fff); }
        #start-btn { width: 120px; height: 120px; border-radius: 50%; background: #111; border: 2px solid #333; color: #fff; font-weight: 900; box-shadow: 0 0 40px rgba(255,255,255,0.1); cursor: pointer; margin-top: 40px; }

        #main-ui { width: 100vw; height: 100vh; display: none; align-items: center; justify-content: center; background: #000; padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }
        
        /* CHASSIS WITH CARBON FIBER TEXTURE */
        #chassis { 
            width: 94%; height: 97%; position: relative; background: var(--car); 
            background-image: linear-gradient(45deg, rgba(0,0,0,0.1) 25%, transparent 25%, transparent 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1) 75%, transparent 75%, transparent);
            background-size: 4px 4px;
            border-radius: var(--shape); display: flex; flex-direction: column; box-shadow: 0 40px 100px rgba(0,0,0,0.9); transition: 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); overflow: hidden; border: 1px solid rgba(255,255,255,0.1); 
        }

        /* NEW: SPEEDOMETER INTERFACE */
        #dashboard {
            position: absolute; top: 75px; left: 30px; width: 60px; height: 60px;
            border: 3px solid rgba(255,255,255,0.1); border-radius: 50%; border-top-color: var(--accent);
            transform: rotate(-45deg); transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #needle {
            position: absolute; top: 50%; left: 50%; width: 25px; height: 2px;
            background: var(--accent); transform-origin: left center;
            transform: rotate(0deg); transition: 0.3s;
        }

        #reflection { position: absolute; inset: 0; background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, transparent 50%, rgba(255,255,255,0.1) 100%); pointer-events: none; z-index: 5; opacity: 0.3; mix-blend-mode: overlay; transition: 0.1s linear; }

        .headlight { position: absolute; top: 15px; width: 65px; height: 22px; background: #fff; border-radius: 50px; box-shadow: 0 0 40px var(--glow); z-index: 10; opacity: 0.9; transition: 0.3s; }
        .l-light { left: 35px; } .r-light { right: 35px; }
        #mirror { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 110px; height: 42px; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); border-radius: 0 0 30px 30px; z-index: 100; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(255,255,255,0.15); color: white; font-size: 14px; letter-spacing: 1px; }
        
        #exit-track { position: absolute; top: 50px; left: 50%; transform: translateX(-50%); width: 160px; height: 4px; background: rgba(0,0,0,0.3); border-radius: 10px; z-index: 90; }
        #exit-slider { width: 60px; height: 24px; background: #fff; border-radius: 12px; position: absolute; top: -10px; left: 0; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 900; color: #000; box-shadow: 0 0 15px #fff; transition: left 0.05s linear; touch-action: none; }

        .windshield { margin: 95px 22px 10px; height: 24%; background: rgba(0,0,0,0.95); backdrop-filter: blur(25px); border-radius: 30px; border: 1px solid rgba(255,255,255,0.15); padding: 25px; display: flex; flex-direction: column; justify-content: flex-end; text-align: right; position: relative; overflow: hidden; }
        .mini-jag { position: absolute; left: 25px; top: 20px; font-size: 9px; letter-spacing: 4px; color: var(--accent); opacity: 0.6; font-weight: 700; }
        
        #layer-eq { color: rgba(255,255,255,0.5); font-size: 1.1rem; white-space: nowrap; overflow-x: auto; overflow-y: hidden; direction: ltr; margin-bottom: 5px; font-weight: 400; text-shadow: 0 0 10px var(--glow); scroll-behavior: smooth; }
        #layer-eq::-webkit-scrollbar { display: none; }
        #layer-ans { color: var(--accent); font-size: 2.7rem; font-weight: 800; line-height: 1; text-shadow: 0 0 25px var(--glow); white-space: nowrap; overflow: hidden; }

        .keypad { flex: 1; display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; padding: 10px 22px 30px; align-content: stretch; position: relative; z-index: 10; }
        .key { background: var(--key); border-radius: 24px; font-size: 1.7rem; font-weight: 500; color: var(--text); display: flex; align-items: center; justify-content: center; transition: 0.1s; border: 1px solid rgba(255,255,255,0.03); width: 100%; height: 100%; }
        
        /* NEW: KEY ACTION ANIMATION */
        .key:active { transform: scale(0.85) skewX(-5deg); }
        .key.active-glow { background: var(--accent) !important; color: #000 !important; box-shadow: 0 0 45px var(--glow); }
        .k-eq { background: var(--accent) !important; color: #000 !important; font-size: 2.3rem; font-weight: 900; }

        .panel { position: fixed; inset: 0; z-index: 2000; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.85); backdrop-filter: blur(15px); }
        .panel.open { display: flex; }
        .modal { width: 92%; max-width: 400px; background: #0a0a0a; border: 1px solid rgba(255,255,255,0.12); border-radius: 40px; padding: 30px; color: #fff; box-shadow: 0 40px 100px #000; max-height: 85vh; display: flex; flex-direction: column; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal h2 { font-weight: 300; letter-spacing: 5px; font-size: 1.2rem; color: var(--accent); }
        .clear-btn { background: rgba(255,59,59,0.15); color: #ff3b3b; border: 1px solid #ff3b3b; padding: 8px 14px; border-radius: 12px; font-size: 0.7rem; font-weight: 800; cursor: pointer; }
        
        .row { background: rgba(255,255,255,0.03); padding: 12px 18px; border-radius: 18px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255,255,255,0.05); }
        select { background: #000; color: var(--accent); border: 1px solid #333; padding: 6px; border-radius: 10px; font-size: 0.8rem; width: 130px; text-align: center; color-scheme: dark; }
        
        .sw { width: 50px; height: 24px; background: #222; border-radius: 20px; position: relative; border: 1px solid #444; }
        .sw.on { background: var(--accent); border-color: var(--accent); }
        .sw::after { content:''; position:absolute; width:18px; height:18px; background:#fff; border-radius:50%; top:2px; left:4px; transition: 0.2s; }
        .sw.on::after { transform: translateX(24px); background: #000; }
        
        #history-box { margin-top: 10px; flex: 1; overflow-y: auto; background: rgba(255,255,255,0.02); border-radius: 20px; padding: 10px; border: 1px solid rgba(255,255,255,0.05); }
        .hist-item { padding: 10px; color: var(--accent); border-bottom: 1px solid rgba(255,255,255,0.05); font-family: monospace; font-size: 0.9rem; text-align: right; text-shadow: 0 0 5px var(--glow); }
    </style>
</head>
<body class="t-0">

<div id="splash">
    <div class="jag-logo">üêÜ</div>
    <button id="start-btn" onclick="startEngine()">POWER ON</button>
</div>

<div id="main-ui">
    <div id="chassis">
        <div id="reflection"></div>
        
        <div id="dashboard"><div id="needle"></div></div>

        <div class="headlight l-light" id="head-l"></div><div class="headlight r-light" id="head-r"></div>
        <div id="mirror" onclick="toggleSet()">‚öôÔ∏è GARAGE</div>
        <div id="exit-track"><div id="exit-slider">OFF</div></div>
        
        <div class="windshield" onclick="cycleThemeLogic()">
            <div class="mini-jag">V12 PLATINUM</div>
            <div id="layer-eq">0</div>
            <div id="layer-ans">0</div>
        </div>

        <div class="keypad" id="pad">
            <button class="key" data-val="AC" style="color:#ff3b3b">AC</button>
            <button class="key" data-val="DEL">‚å´</button>
            <button class="key" data-val="%">%</button>
            <button class="key" data-val="/" style="color:var(--accent)">√∑</button>
            <button class="key" data-val="7">7</button><button class="key" data-val="8">8</button><button class="key" data-val="9">9</button>
            <button class="key" data-val="*" style="color:var(--accent)">√ó</button>
            <button class="key" data-val="4">4</button><button class="key" data-val="5">5</button><button class="key" data-val="6">6</button>
            <button class="key" data-val="-" style="color:var(--accent)">‚àí</button>
            <button class="key" data-val="1">1</button><button class="key" data-val="2">2</button><button class="key" data-val="3">3</button>
            <button class="key" data-val="+" style="color:var(--accent)">+</button>
            <button class="key" data-val="00">00</button>
            <button class="key" data-val="0">0</button><button class="key" data-val=".">.</button>
            <button class="key k-eq" data-val="=">=</button>
        </div>
    </div>
</div>

<div id="settings" class="panel" onclick="if(event.target == this) toggleSet()">
    <div class="modal">
        <div class="modal-header">
            <h2>LOGS & SOUNDS</h2>
            <button class="clear-btn" onclick="clearHistory()">RESET</button>
        </div>
        <div id="history-box"></div>
        <div style="margin-top:15px; overflow-y: auto;">
            <div class="row">Soft Beep <select id="b-sel" onchange="save('beepProf', this.value)"></select></div>
            <div class="row">Piano <select id="p-sel" onchange="save('pianoProf', this.value)"></select></div>
            <div class="row">AI Voice <select id="v-type" onchange="save('vType', this.value)">
                <option value="superstar">Superstar (Deep)</option>
                <option value="diva">Diva (Sharp)</option>
                <option value="child">Junior Racer (Child)</option>
                <option value="cartoon">Toon Mode (Cartoon)</option>
                <option value="v12">V12 Engine</option>
            </select></div>
            <div class="row">Voice On <div id="v-sw" class="sw" onclick="toggle('isSpeak')"></div></div>
            <div class="row">Gujarati <div id="g-sw" class="sw" onclick="toggle('isG')"></div></div>
        </div>
        <button class="key k-eq" style="width:100%; height:50px; margin-top:10px; border-radius:18px; font-size: 1rem;" onclick="toggleSet()">EXIT GARAGE</button>
    </div>
</div>

<script>
    let equationArr = [], currentInput = "", isResultShown = false, lastFullEq = "";
    let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    let settings = {
        beepProf: localStorage.getItem('beepProf') || "b1",
        pianoProf: localStorage.getItem('pianoProf') || "none",
        vType: localStorage.getItem('vType') || "superstar",
        isG: localStorage.getItem('isG') === 'true',
        isSpeak: localStorage.getItem('isSpeak') !== 'false',
        themeIdx: parseInt(localStorage.getItem('themeIdx')) || 0,
        isRound: localStorage.getItem('isRound') === 'true'
    };

    const gMap = {'0':'‡´¶','1':'‡´ß','2':'‡´®','3':'‡´©','4':'‡´™','5':'‡´´','6':'‡´¨','7':'‡´≠','8':'‡´Æ','9':'‡´Ø','+':'+','-':'-','*':'√ó','/':'√∑','=':'=','.':'.','00':'‡´¶‡´¶','AC':'AC','DEL':'‚å´','%':'%'};
    const freqMap = { 'AC':261,'DEL':293,'%':329,'/':349,'7':392,'8':440,'9':493,'*':523,'4':587,'5':659,'6':698,'-':783,'1':880,'2':987,'3':1046,'+':1174,'0':1396,'.':1567,'=':1760,'00':1300 };
    
    const beeps = [
        {name:"Soft Tap",f:800,t:'sine',d:0.1}, {name:"Silk Touch",f:1200,t:'sine',d:0.05}, 
        {name:"Digital Click",f:2000,t:'square',d:0.02}, {name:"Low Pulse",f:150,t:'triangle',d:0.15}, 
        {name:"Bubble Pop",f:600,t:'sine',d:0.2}, {name:"Feather",f:400,t:'sine',d:0.05}, 
        {name:"Glass Ting",f:2500,t:'sine',d:0.1}, {name:"Sport Beep",f:1000,t:'sawtooth',d:0.05},
        {name:"Eco Click",f:700,t:'sine',d:0.03}
    ];

    const pianoLib = [
        {name:"Grand Piano",t:'triangle',d:1.2,g:0.15}, {name:"Studio One",t:'sine',d:0.8,g:0.2},
        {name:"Mellow Gold",t:'sine',d:1.5,g:0.1}, {name:"Honky Tonk",t:'sawtooth',d:0.6,g:0.05},
        {name:"Electric Sky",t:'square',d:1.0,g:0.04}, {name:"Classic 88",t:'triangle',d:0.9,g:0.1},
        {name:"Toy Box",t:'sine',d:0.3,g:0.3}, {name:"Bright Key",t:'triangle',d:0.5,g:0.2},
        {name:"Dark Night",t:'sine',d:2.0,g:0.08}, {name:"Dream State",t:'triangle',d:2.5,g:0.05},
        {name:"Space Echo",t:'square',d:2.0,g:0.02}, {name:"Jazz Club",t:'sawtooth',d:0.8,g:0.03},
        {name:"Crystal Bell",t:'sine',d:0.4,g:0.4}, {name:"Soft Wool",t:'triangle',d:1.8,g:0.07},
        {name:"Cinematic",t:'sawtooth',d:3.0,g:0.02}
    ];

    function startEngine() {
        const doc = window.document.documentElement;
        if (doc.requestFullscreen) doc.requestFullscreen();
        if (audioCtx.state === 'suspended') audioCtx.resume();
        playHorn();
        speak("V12 Engine Ignited");
        document.getElementById('splash').style.opacity = '0';
        setTimeout(() => { 
            document.getElementById('splash').style.display='none'; 
            document.getElementById('main-ui').style.display='flex'; 
        }, 600);
        
        // Tilt Effect
        if (window.DeviceOrientationEvent) {
            window.addEventListener('deviceorientation', (e) => {
                const refl = document.getElementById('reflection');
                const x = e.gamma * 2;
                const y = e.beta * 2;
                refl.style.transform = `translate(${x}px, ${y}px)`;
            });
        }
    }

    function playHorn() {
        const now = audioCtx.currentTime;
        [380, 480].forEach(f => {
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
            o.type = 'sawtooth'; o.frequency.value = f; g.gain.setValueAtTime(0.05, now);
            g.gain.exponentialRampToValueAtTime(0.001, now + 0.6);
            o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(now + 0.6);
        });
    }

    function handleKey(v, element) {
        if (navigator.vibrate) navigator.vibrate(15);
        element.classList.add('active-glow');
        setTimeout(() => element.classList.remove('active-glow'), 120);
        
        // Move needle based on key value
        let val = parseInt(v) || 5;
        document.getElementById('needle').style.transform = `rotate(${val * 18}deg)`;

        playTone(v);
        
        if(v === 'AC') { 
            equationArr = []; currentInput = ""; isResultShown = false; lastFullEq = ""; 
            speak("System Reset"); 
        }
        else if(v === 'DEL') { 
            if(isResultShown) { equationArr = []; currentInput = ""; isResultShown = false; lastFullEq = ""; } 
            else if (currentInput.length > 0) { currentInput = currentInput.slice(0,-1); } 
            else if (equationArr.length > 0) { equationArr.pop(); }
            speak("Shift back");
        }
        else if(['+','-','*','/'].includes(v)) {
            if(isResultShown) { equationArr = [currentInput, v]; isResultShown = false; currentInput = ""; } 
            else {
                if(currentInput !== "") equationArr.push(currentInput);
                if(equationArr.length && isNaN(equationArr[equationArr.length-1])) { equationArr[equationArr.length-1] = v; } 
                else if(equationArr.length) { equationArr.push(v); }
                currentInput = "";
            }
        }
        else if(v === '=') {
            let res = calculateArr([...equationArr, currentInput]);
            lastFullEq = equationArr.join(" ") + (currentInput ? " " + currentInput : "") + " = " + res;
            addHistory(lastFullEq);
            currentInput = res; equationArr = []; isResultShown = true;
            document.getElementById('needle').style.transform = `rotate(180deg)`;
            speak(res, true);
        } else {
            if(isResultShown) { currentInput = v; isResultShown = false; lastFullEq = ""; }
            else { currentInput += v; }
            speak(v);
        }
        updateDisplay();
    }

    function calculateArr(arr) {
        try { 
            let s = arr.filter(x => x !== "").join(" ").replace(/√ó/g,'*').replace(/√∑/g,'/');
            if(s.length === 0) return "0";
            if(['+','-','*','/'].includes(s.trim().slice(-1))) s = s.trim().slice(0, -1);
            let result = eval(s);
            return Number(result.toFixed(8)).toString(); 
        } catch { return "0"; }
    }

    function updateDisplay() {
        const toG = (s) => settings.isG ? s.toString().replace(/[0-9]/g, x => gMap[x]) : s;
        let l1Str = isResultShown ? lastFullEq : equationArr.join(" ") + (currentInput !== "" ? (equationArr.length ? " " : "") + currentInput : "");
        const eqEl = document.getElementById('layer-eq');
        eqEl.innerText = toG(l1Str || "0");
        setTimeout(() => { eqEl.scrollLeft = eqEl.scrollWidth; }, 10);
        let resValue = isResultShown ? currentInput : calculateArr([...equationArr, currentInput]);
        document.getElementById('layer-ans').innerText = toG(resValue);
    }

    function save(k, v) { settings[k] = v; localStorage.setItem(k, v); }
    function toggle(k) { settings[k] = !settings[k]; save(k, settings[k]); initUI(); }
    
    function cycleThemeLogic() {
        if (settings.isRound) { settings.isRound = false; settings.themeIdx = (settings.themeIdx + 1) % 20; } 
        else { settings.isRound = true; }
        save('themeIdx', settings.themeIdx);
        save('isRound', settings.isRound);
        initUI();
    }

    function toggleSet() { document.getElementById('settings').classList.toggle('open'); }

    function initUI() {
        document.body.className = `t-${settings.themeIdx} ${settings.isRound ? 'is-round' : ''}`;
        document.getElementById('v-sw').className = `sw ${settings.isSpeak ? 'on' : ''}`;
        document.getElementById('g-sw').className = `sw ${settings.isG ? 'on' : ''}`;
        document.getElementById('v-type').value = settings.vType;
        document.getElementById('b-sel').innerHTML = '<option value="none">Mute</option>' + beeps.map((n, i) => `<option value="b${i+1}">${n.name}</option>`).join('');
        document.getElementById('b-sel').value = settings.beepProf;
        document.getElementById('p-sel').innerHTML = '<option value="none">Mute Piano</option>' + pianoLib.map((n, i) => `<option value="p${i+1}">${n.name}</option>`).join('');
        document.getElementById('p-sel').value = settings.pianoProf;
        document.querySelectorAll('.key').forEach(k => { if(k.dataset.val) k.innerText = settings.isG ? (gMap[k.dataset.val] || k.dataset.val) : k.dataset.val; });
        renderHistory(); updateDisplay();
    }

    function addHistory(item) {
        let h = JSON.parse(localStorage.getItem('jag_hist') || "[]");
        h.unshift(item); if(h.length > 10) h = h.slice(0, 10);
        localStorage.setItem('jag_hist', JSON.stringify(h));
        renderHistory();
    }
    
    function renderHistory() {
        const h = JSON.parse(localStorage.getItem('jag_hist') || "[]");
        const toG = (s) => settings.isG ? s.toString().replace(/[0-9]/g, x => gMap[x]) : s;
        document.getElementById('history-box').innerHTML = h.length ? h.map(i => `<div class="hist-item">${toG(i)}</div>`).join('') : '<div style="text-align:center; opacity:0.3; padding:20px;">No Logs</div>';
    }

    function clearHistory() { localStorage.removeItem('jag_hist'); renderHistory(); }

    function playTone(v) {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const now = audioCtx.currentTime;
        if(settings.vType === 'v12') {
            const revFreq = 100 + (parseInt(v) || 5) * 20;
            const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
            o.type = 'sawtooth'; o.frequency.value = revFreq;
            g.gain.setValueAtTime(0.05, now); g.gain.exponentialRampToValueAtTime(0.001, now + 0.3);
            o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(now + 0.3);
        }
        if(settings.beepProf !== 'none') {
            const bIndex = parseInt(settings.beepProf.substring(1)) - 1;
            if(beeps[bIndex]) {
                const b = beeps[bIndex];
                const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
                o.type = b.t; o.frequency.value = b.f; g.gain.setValueAtTime(0.03, now);
                g.gain.exponentialRampToValueAtTime(0.001, now + b.d);
                o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(now + b.d);
            }
        }
    }

    function speak(t, isFinal = false) {
        if(!settings.isSpeak) return;
        window.speechSynthesis.cancel();
        const msg = new SpeechSynthesisUtterance();
        msg.text = isFinal ? (settings.isG ? "‡™ú‡™µ‡™æ‡™¨ ‡™õ‡´á " + t : "The answer is " + t) : t;
        msg.lang = settings.isG ? 'gu-IN' : 'en-IN';
        if(settings.vType === 'superstar') { msg.pitch = 0.5; msg.rate = 0.8; } 
        else if(settings.vType === 'diva') { msg.pitch = 1.3; msg.rate = 1.1; } 
        else { msg.pitch = 1.0; msg.rate = 1.0; }
        window.speechSynthesis.speak(msg);
    }

    const slider = document.getElementById('exit-slider');
    let isDragging = false, startX = 0;
    slider.addEventListener('touchstart', (e) => { isDragging = true; startX = e.touches[0].clientX; slider.style.transition = 'none'; });
    window.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        let x = Math.max(0, Math.min(e.touches[0].clientX - startX, 100));
        slider.style.left = x + 'px';
        if (x >= 95) location.reload();
    });
    window.addEventListener('touchend', () => { isDragging = false; slider.style.transition = 'left 0.3s'; slider.style.left = '0px'; });

    document.getElementById('pad').addEventListener('touchstart', e => {
        if(e.target.dataset.val) { e.preventDefault(); handleKey(e.target.dataset.val, e.target); }
    });
    initUI();
</script>
</body>
</html>
