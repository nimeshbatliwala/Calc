<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Bistro Orchestra Max</title>
    <style>
        :root {
            --safe-top: env(safe-area-inset-top, 25px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --depth: 7px;
        }

        /* THEMES */
        body.t-0 { --bg: #000; --text: #fff; --radius: 12px; } 
        body.t-1 { --bg: #f8fafc; --text: #0f172a; --radius: 18px; } 
        body.t-2 { --bg: #050505; --text: #00ff41; --radius: 5px; } 
        body.t-3 { --bg: #1e1b4b; --text: #e0e7ff; --radius: 50%; } 
        body.t-4 { --bg: #2d0036; --text: #ff00ff; --radius: 25px 5px; } 
        body.t-5 { --bg: #fef3c7; --text: #92400e; --radius: 0px; } 

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        html, body { 
            width: 100vw; height: 100vh; overflow: hidden; position: fixed; top: 0; left: 0;
            background: var(--bg); color: var(--text); font-family: -apple-system, system-ui, sans-serif; transition: 0.5s;
        }

        /* SPLASH SCREEN */
        #splash {
            position: fixed; inset: 0; background: #000; z-index: 5000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #fff; transition: 0.6s ease-in-out;
        }
        #splash h1 { font-size: 2.5rem; margin-bottom: 30px; text-align: center; font-weight: 900; background: linear-gradient(to right, #ff9500, #ff00ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        #start-btn { padding: 15px 50px; font-size: 1.5rem; font-weight: 800; border-radius: 50px; border: none; background: #ff9500; color: #fff; box-shadow: 0 5px 15px rgba(255,149,0,0.4); }

        /* EXIT SLIDER */
        .exit-container {
            width: 220px; height: 44px; background: rgba(255,255,255,0.1); 
            margin: calc(var(--safe-top) + 10px) auto 0; border-radius: 22px;
            position: relative; border: 1px solid rgba(255,255,255,0.2); overflow: hidden;
        }
        .exit-text { position: absolute; width: 100%; text-align: center; line-height: 44px; font-size: 0.85rem; font-weight: bold; color: #ff4444; pointer-events: none; }
        #exit-handle {
            width: 60px; height: 38px; background: #ff4444; border-radius: 19px;
            position: absolute; top: 2px; left: 2px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;
        }

        /* CALCULATOR LAYOUT - MOVED TO BOTTOM */
        #calc-ui { 
            display: flex; 
            flex-direction: column; 
            width: 100%; 
            height: 100%; 
            opacity: 0; 
            pointer-events: none; 
            transition: 0.5s;
            justify-content: flex-end; /* Pushes content to the bottom */
        }
        #calc-ui.visible { opacity: 1; pointer-events: auto; }

        .display { 
            padding: 10px 25px; 
            text-align: right; 
            overflow: hidden;
            margin-bottom: 10px;
        }
        #tape { font-size: 1.6rem; min-height: 2.2rem; overflow-x: auto; white-space: nowrap; margin-bottom: 5px; font-weight: 700; color: #ff9500; scrollbar-width: none; }
        #main-val { font-size: clamp(2.5rem, 14vw, 6rem); font-weight: 900; line-height: 1.1; }

        /* KEYPAD AT THE VERY BOTTOM */
        .keypad { 
            padding: 10px 18px calc(var(--safe-bottom) + 10px); 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 12px; 
            width: 100%; 
        }

        .key {
            width: 100%; height: 72px; border-radius: var(--radius); border: 1px solid rgba(255,255,255,0.3);
            color: #fff; font-size: 1.8rem; font-weight: 800; display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(15px); background: rgba(255,255,255,0.1);
            box-shadow: 0 var(--depth) 0 rgba(0,0,0,0.3), 0 10px 20px rgba(0,0,0,0.2);
            position: relative; transition: 0.05s;
        }
        .key:active { transform: translateY(var(--depth)); box-shadow: 0 0 0 rgba(0,0,0,0.3); filter: brightness(1.5); }

        /* COLORS */
        .k-ac { background: linear-gradient(135deg, #d442ab, #7d44cf); }
        .k-del { background: linear-gradient(135deg, #3a4b8a, #242f5e); }
        .k-perc { background: linear-gradient(135deg, #12b4a5, #12d4a5); }
        .k-div { background: linear-gradient(135deg, #f782c2, #f35588); }
        .k-7, .k-8, .k-9 { background: linear-gradient(135deg, #7c8d8c, #aebbb9); color: #000; }
        .k-4, .k-5, .k-6 { background: linear-gradient(135deg, #44f0a5, #44f0d5); color: #000; }
        .k-1, .k-2, .k-3 { background: linear-gradient(135deg, #ffb07c, #ff7c8d); color: #000; }
        .k-mult, .k-sub, .k-add, .k-eq { background: linear-gradient(180deg, #ffb347, #ff9500); }
        .k-0, .k-dot, .k-set { background: linear-gradient(135deg, #1d3a7d, #2a5298); }

        /* SETTINGS SHEET */
        .sheet { position: fixed; inset: 0; background: rgba(0,0,0,0.97); backdrop-filter: blur(40px); z-index: 1000; transform: translateY(100%); transition: 0.5s; padding: calc(var(--safe-top) + 20px) 20px var(--safe-bottom); overflow-y: auto; }
        .sheet.open { transform: translateY(0); }
        .card { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.1); padding: 18px; border-radius: 20px; margin-bottom: 12px; }
        .row { display: flex; justify-content: space-between; align-items: center; font-weight: 800; color: #fff; }
        .sw-3d { width: 60px; height: 30px; background: #000; border-radius: 20px; position: relative; border: 1px solid rgba(255,255,255,0.2); }
        .sw-3d::after { content: ''; position: absolute; width: 24px; height: 24px; background: #fff; border-radius: 50%; top: 2px; left: 2px; transition: 0.3s; }
        .sw-3d.active { background: #38ef7d; }
        .sw-3d.active::after { transform: translateX(30px); }
        select { background: #1a1a1a; color: #fff; border: 1px solid rgba(255,255,255,0.2); padding: 8px; border-radius: 8px; width: 150px; font-weight: bold; }
        #hist-box { margin-top: 10px; max-height: 150px; overflow-y: auto; color: #ccc; font-size: 0.85rem; }
        .hist-item { padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; }
    </style>
</head>
<body class="t-0">

    <div id="splash">
        <h1>Bistro Orchestra Max</h1>
        <button id="start-btn" onclick="startApp()">START</button>
    </div>

    <div id="calc-ui">
        <div style="position: fixed; top: 0; width: 100%;">
            <div class="exit-container" id="exit-bar">
                <div class="exit-text">Slide to Close App ✖</div>
                <div id="exit-handle">▶</div>
            </div>
        </div>

        <div class="display" onclick="cycleTheme()">
            <div id="tape"></div>
            <div id="main-val">0</div>
        </div>

        <div class="keypad" id="pad">
            <button class="key k-ac" data-val="AC">AC</button>
            <button class="key k-del" data-val="DEL">⌫</button>
            <button class="key k-perc" data-val="%">%</button>
            <button class="key k-div" data-val="/">÷</button>
            <button class="key k-7" data-val="7">7</button>
            <button class="key k-8" data-val="8">8</button>
            <button class="key k-9" data-val="9">9</button>
            <button class="key k-mult" data-val="*">×</button>
            <button class="key k-4" data-val="4">4</button>
            <button class="key k-5" data-val="5">5</button>
            <button class="key k-6" data-val="6">6</button>
            <button class="key k-sub" data-val="-">−</button>
            <button class="key k-1" data-val="1">1</button>
            <button class="key k-2" data-val="2">2</button>
            <button class="key k-3" data-val="3">3</button>
            <button class="key k-add" data-val="+">+</button>
            <button class="key k-set" data-val="SET">⚙️</button>
            <button class="key k-0" data-val="0">0</button>
            <button class="key k-dot" data-val=".">.</button>
            <button class="key k-eq" data-val="=">=</button>
        </div>
    </div>

    <div id="settings" class="sheet">
        <h2 style="text-align:center; color:#fff; margin-bottom:20px;">AUDIO STUDIO</h2>
        
        <div class="card"><div class="row">Soft Beeps 
            <select id="beep-prof" onchange="changeSound('beep', this.value)">
                <option value="none">None</option>
                <option value="soft1">Soft Tap</option>
                <option value="soft2">Silk Beep</option>
                <option value="soft3">Digital Click</option>
                <option value="soft4">Pulse</option>
                <option value="soft5">Bubble</option>
            </select>
        </div></div>

        <div class="card"><div class="row">Piano Tunes 
            <select id="piano-prof" onchange="changeSound('piano', this.value)">
                <option value="none">None</option>
                <option value="piano1">Grand Piano</option>
                <option value="piano15">Cinematic Grand</option>
            </select>
        </div></div>

        <div class="card"><div class="row">Voice Guide <div id="v-sw" class="sw-3d" onclick="toggle('isSpeak')"></div></div></div>
        <div class="card"><div class="row">Gujarati Mode <div id="g-sw" class="sw-3d" onclick="toggle('isG')"></div></div></div>
        
        <div class="card">
            <div class="row">History <span onclick="clearHistory()" style="font-size: 0.7rem; color: #ff5555;">Clear</span></div>
            <div id="hist-box"></div>
        </div>
        <button class="key k-add" style="width:100%; height:60px;" onclick="setOp()">DONE</button>
    </div>

<script>
    let cur = "0", tapeStr = "", lastOp = "", baseVal = 0, isRes = false;
    let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    let settings = {
        beepProf: localStorage.getItem('beepProf') || "soft1",
        pianoProf: localStorage.getItem('pianoProf') || "none",
        isG: localStorage.getItem('isG') === 'true',
        isSpeak: localStorage.getItem('isSpeak') !== 'false',
        themeIdx: parseInt(localStorage.getItem('themeIdx')) || 0
    };

    const gMap = {'0':'૦','1':'૧','2':'૨','3':'૩','4':'૪','5':'૫','6':'૬','7':'૭','8':'૮','9':'૯','+':'+','-':'-','*':'×','/':'÷','=':'=','.':'.'};
    const notes = {'AC':261,'DEL':293,'%':329,'/':349,'7':392,'8':440,'9':493,'*':523,'4':587,'5':659,'6':698,'-':783,'1':880,'2':987,'3':1046,'+':1174,'SET':1318,'0':1396,'.':1567,'=':1760};

    function startApp() {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        
        // Comprehensive Fullscreen request
        const docElm = document.documentElement;
        const requestFS = docElm.requestFullscreen || docElm.webkitRequestFullScreen || docElm.mozRequestFullScreen || docElm.msRequestFullscreen;
        if(requestFS) requestFS.call(docElm);

        document.getElementById('splash').style.transform = 'translateY(-100%)';
        document.getElementById('calc-ui').classList.add('visible');
    }

    // Slider Logic
    const handle = document.getElementById('exit-handle');
    let startX = 0, currentX = 0;
    handle.addEventListener('touchstart', (e) => startX = e.touches[0].clientX);
    handle.addEventListener('touchmove', (e) => {
        let maxSlide = 158; 
        currentX = Math.min(maxSlide, Math.max(2, e.touches[0].clientX - startX));
        handle.style.left = currentX + 'px';
        if (currentX >= 155) { 
            const exitFS = document.exitFullscreen || document.webkitExitFullscreen || document.mozCancelFullScreen || document.msExitFullscreen;
            if(exitFS) exitFS.call(document);
            window.close(); 
        }
    });
    handle.addEventListener('touchend', () => { if(currentX < 155) handle.style.left = '2px'; });

    function save(k, v) { settings[k] = v; localStorage.setItem(k, v); }
    function toggle(k) { settings[k] = !settings[k]; save(k, settings[k]); initUI(); }
    
    function changeSound(type, val) {
        if(type === 'beep') { save('beepProf', val); }
        else { save('pianoProf', val); }
    }

    function initUI() {
        document.getElementById('beep-prof').value = settings.beepProf;
        document.getElementById('piano-prof').value = settings.pianoProf;
        document.getElementById('v-sw').className = `sw-3d ${settings.isSpeak ? 'active' : ''}`;
        document.getElementById('g-sw').className = `sw-3d ${settings.isG ? 'active' : ''}`;
        document.body.className = `t-${settings.themeIdx}`;
        loadHistory();
        updateDisplay();
    }

    document.getElementById('pad').addEventListener('touchstart', e => {
        const b = e.target.closest('.key');
        if (b) { e.preventDefault(); handleKey(b.dataset.val); }
    }, {passive: false});

    function handleKey(v) {
        playTone(notes[v]);
        if (v === 'SET') return setOp();
        if (v === 'AC') { cur = "0"; tapeStr = ""; lastOp = ""; baseVal = 0; isRes = false; speak("Clear"); }
        else if (v === 'DEL') { 
            if (isRes) { tapeStr = ""; isRes = false; }
            cur = cur.length > 1 ? cur.slice(0,-1) : "0"; speak("Back"); 
        }
        else if (['+','-','*','/'].includes(v)) {
            if (isRes) { tapeStr = cur + " " + v + " "; isRes = false; }
            else if (cur === "0" && tapeStr !== "") { tapeStr = tapeStr.trim().split(' ').slice(0, -1).join(' ') + " " + v + " "; }
            else { tapeStr += cur + " " + v + " "; }
            baseVal = parseFloat(cur); lastOp = v; cur = "0"; speak(v);
        }
        else if (v === '%') {
            let currentNum = parseFloat(cur);
            if (lastOp === '+' || lastOp === '-') { cur = ((baseVal * currentNum) / 100).toString(); } 
            else { cur = (currentNum / 100).toString(); }
            speak("percent");
        }
        else if (v === '=') {
            let expr = tapeStr.trim();
            if (cur !== "0" || !expr) expr += " " + cur;
            if (['+','-','*','/'].includes(expr.slice(-1))) expr = expr.slice(0, -1).trim();
            try {
                let r = eval(expr.replace(/×/g, '*').replace(/÷/g, '/'));
                let result = parseFloat(r.toFixed(8)).toString();
                addHistory(expr + " = " + result);
                cur = result; speak(cur); tapeStr = expr; isRes = true;
            } catch(e) { cur = "Error"; }
        }
        else {
            if (isRes) { cur = v; tapeStr = ""; isRes = false; }
            else { cur = (cur === "0") ? v : cur + v; }
            speak(v);
        }
        updateDisplay();
    }

    function playTone(f) {
        const now = audioCtx.currentTime;
        if (settings.beepProf !== 'none') {
            const gB = audioCtx.createGain(); gB.connect(audioCtx.destination);
            const oB = audioCtx.createOscillator(); oB.connect(gB);
            oB.type = 'sine';
            let bVol = 0.1, bDecay = 0.08;
            oB.frequency.setValueAtTime(f * 1.5, now);
            gB.gain.setValueAtTime(0, now);
            gB.gain.linearRampToValueAtTime(bVol, now + 0.005);
            gB.gain.exponentialRampToValueAtTime(0.0001, now + bDecay);
            oB.start(now); oB.stop(now + bDecay);
        }
        if (settings.pianoProf !== 'none') {
            const gP = audioCtx.createGain(); gP.connect(audioCtx.destination);
            const oP = audioCtx.createOscillator(); oP.connect(gP);
            oP.type = 'triangle'; oP.frequency.setValueAtTime(f, now);
            gP.gain.setValueAtTime(0, now);
            gP.gain.linearRampToValueAtTime(0.2, now + 0.02);
            gP.gain.exponentialRampToValueAtTime(0.001, now + 1.2);
            oP.start(now); oP.stop(now + 1.2);
        }
    }

    function addHistory(i) {
        let h = JSON.parse(localStorage.getItem('calcHistory') || "[]");
        h.unshift(i); if(h.length > 15) h.pop();
        localStorage.setItem('calcHistory', JSON.stringify(h));
        loadHistory();
    }
    function loadHistory() {
        let h = JSON.parse(localStorage.getItem('calcHistory') || "[]");
        document.getElementById('hist-box').innerHTML = h.map(x => `<div class="hist-item"><span>${x.split('=')[0]}</span><b>= ${x.split('=')[1]}</b></div>`).join('');
    }
    function clearHistory() { localStorage.setItem('calcHistory', "[]"); loadHistory(); }
    
    function updateDisplay() {
        let dv = settings.isG ? cur.replace(/[0-9]/g, x => gMap[x]) : cur;
        let activeInput = (cur === "0" && !isRes) ? "" : cur;
        let displayTape = isRes ? tapeStr : (tapeStr + activeInput);
        let tv = settings.isG ? displayTape.replace(/[0-9]/g, x => gMap[x]) : displayTape;
        document.getElementById('main-val').innerText = dv;
        const t = document.getElementById('tape'); 
        t.innerText = tv.trim(); t.scrollLeft = t.scrollWidth;
    }
    
    function speak(t) {
        if(!settings.isSpeak) return;
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(t);
        u.lang = settings.isG ? 'gu-IN' : 'en-IN';
        u.rate = 1.7; window.speechSynthesis.speak(u);
    }
    function cycleTheme() { settings.themeIdx = (settings.themeIdx + 1) % 6; save('themeIdx', settings.themeIdx); document.body.className = `t-${settings.themeIdx}`; }
    function setOp() { document.getElementById('settings').classList.toggle('open'); }
    initUI();
</script>
</body>
</html>
